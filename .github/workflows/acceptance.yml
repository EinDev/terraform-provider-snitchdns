name: Acceptance Tests

on:
  push:
    branches: [ master, main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'examples/**/*.md'
  pull_request:
    branches: [ master, main ]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  acceptance:
    name: Terraform Acceptance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        # Only test latest Terraform on push, full matrix on PR and schedule
        terraform:
          - '1.9.*'

    steps:
    - name: Check out code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.24'
        cache: true

    - name: Install Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ matrix.terraform }}
        terraform_wrapper: false

    - name: Install dependencies
      run: go mod download

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build test container with cache
      uses: docker/build-push-action@v6
      with:
        context: ./testcontainer
        load: true
        tags: snitchdns-test:latest
        cache-from: type=gha,scope=testcontainer
        cache-to: type=gha,mode=max,scope=testcontainer

    - name: Run acceptance tests
      run: |
        export TF_ACC=1
        export DOCKER_BUILDKIT=1
        go test -v -timeout 15m -parallel 4 ./internal/provider/... -coverprofile=coverage-acceptance.txt
      env:
        TESTCONTAINERS_RYUK_DISABLED: false

    - name: Upload acceptance test coverage
      uses: codecov/codecov-action@v5
      if: matrix.terraform == '1.9.*'
      with:
        file: ./coverage-acceptance.txt
        flags: acceptance
        name: codecov-acceptance

  # Full matrix test - runs on PR and schedule only
  acceptance-full:
    name: Full Terraform Version Matrix
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request' || github.event_name == 'schedule'

    strategy:
      fail-fast: false
      matrix:
        terraform:
          - '1.0.*'
          - '1.5.*'

    steps:
    - name: Check out code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.24'
        cache: true

    - name: Install Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ matrix.terraform }}
        terraform_wrapper: false

    - name: Install dependencies
      run: go mod download

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build test container with cache
      uses: docker/build-push-action@v6
      with:
        context: ./testcontainer
        load: true
        tags: snitchdns-test:latest
        cache-from: type=gha,scope=testcontainer
        cache-to: type=gha,mode=max,scope=testcontainer

    - name: Run acceptance tests
      run: |
        export TF_ACC=1
        export DOCKER_BUILDKIT=1
        go test -v -timeout 15m -parallel 4 ./internal/provider/...
      env:
        TESTCONTAINERS_RYUK_DISABLED: false

  terraform-fmt:
    name: Terraform Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v6

    - name: Install Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: latest

    - name: Check Terraform formatting in examples
      run: |
        terraform fmt -check -recursive examples/
